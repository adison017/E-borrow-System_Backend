import { Client } from '@line/bot-sdk';
import dotenv from 'dotenv';
import cron from 'node-cron';
import { getActiveBorrows } from '../models/borrowModel.js';
import { formatDate, getDaysBetween, getDaysRemaining } from '../utils/dateHelper.js';
import mysql from 'mysql2/promise';
import db from '../db.js';
dotenv.config();

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö environment variables ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LINE Bot
const token = process.env.token;
const secretcode = process.env.secretcode;

let client = null;

// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ LINE Bot configuration ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á client
if (token && secretcode) {
  client = new Client({
    channelAccessToken: token,
    channelSecret: secretcode
  });
  console.log('‚úÖ LINE Bot configured for scheduled notifications');
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á Channel Access Token ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö
  (async () => {
    try {
      if (typeof client.getBotInfo === 'function') {
        const info = await client.getBotInfo();
        console.log(`‚úÖ LINE token valid. Bot: ${info?.basicId || 'unknown'}`);
      } else {
        // fallback: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å endpoint ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô token
        const quota = await client.getMessageQuota();
        if (quota) console.log('‚úÖ LINE token valid (quota endpoint reachable).');
      }
    } catch (e) {
      console.error('‚ùå LINE token invalid or revoked. Please refresh Channel Access Token.');
      console.error('Detail:', e?.statusCode || e?.status || '', e?.message || e);
    }
  })();
} else {
  console.warn('‚ö†Ô∏è LINE Bot configuration is missing. Scheduled notifications will be disabled.');
  console.warn('Please set "token" and "secretcode" in your .env file to enable LINE notifications.');
}

// ‡∏£‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 00:05 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢/‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø)
cron.schedule('29 0 * * *', async () => {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ LINE Bot configuration ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  if (!client) {
    console.log('Scheduled notification job skipped: LINE Bot not configured');
    return;
  }

  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏≤‡∏á)
    try {
      if (typeof client.getBotInfo === 'function') {
        await client.getBotInfo();
      } else {
        await client.getMessageQuota();
      }
    } catch (verifyErr) {
      console.error('‚ùå Skip job: LINE token invalid/revoked.', verifyErr?.statusCode || verifyErr?.status || '', verifyErr?.message || verifyErr);
      return;
    }

    const borrows = await getActiveBorrows();
    console.log(`Found ${borrows.length} active borrows to notify`);
    for (const borrow of borrows) {
      if (borrow.line_id) {
        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô
        const daysRemaining = getDaysRemaining(borrow.return_date, new Date());
        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: borrow_date ‡∏ñ‡∏∂‡∏á return_date
        const totalDays = getDaysBetween(borrow.borrow_date, borrow.return_date);
        console.log(`borrow_code: ${borrow.borrow_code}, borrow_date: ${borrow.borrow_date}, return_date: ${borrow.return_date}, daysRemaining: ${daysRemaining}, totalDays: ${totalDays}`);
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç 3 ‡∏´‡∏£‡∏∑‡∏≠ 1 ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
        if (!(daysRemaining === 3 || daysRemaining === 1)) {
          console.log(`SKIP: borrow_code: ${borrow.borrow_code} ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç daysRemaining (${daysRemaining}) !== 3 ‡∏´‡∏£‡∏∑‡∏≠ 1`);
          continue;
        }
        // ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 3 ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ 1 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô
        if (daysRemaining === 3 || daysRemaining === 1) {
          const accentColor = daysRemaining === 1 ? '#d32f2f' : '#FB8C00';
          const message = {
            type: "flex",
            altText: `‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysRemaining} ‡∏ß‡∏±‡∏ô)` ,
            contents: {
              type: "bubble",
              header: {
                type: "box",
                layout: "vertical",
                backgroundColor: accentColor,
                paddingAll: "18px",
                contents: [
                  {
                    type: "text",
                    text: "üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå",
                    weight: "bold",
                    size: "lg",
                    color: "#ffffff"
                  },
                  {
                    type: "box",
                    layout: "vertical",
                    backgroundColor: "#ffffff",
                    cornerRadius: "lg",
                    paddingAll: "8px",
                    margin: "md",
                    contents: [
                      {
                        type: "text",
                        text: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${daysRemaining} ‡∏ß‡∏±‡∏ô`,
                        weight: "bold",
                        size: "xxl",
                        color: accentColor,
                        align: "center"
                      }
                    ]
                  }
                ]
              },
              body: {
                type: "box",
                layout: "vertical",
                spacing: "md",
                contents: [
                  {
                    type: "box",
                    layout: "baseline",
                    contents: [
                      { type: "text", text: "‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°", size: "sm", color: "#888888", flex: 3 },
                      { type: "text", text: String(borrow.borrow_code || borrow.borrowid), size: "sm", color: "#111111", flex: 5, weight: "bold", wrap: true }
                    ]
                  },
                  {
                    type: "box",
                    layout: "baseline",
                    contents: [
                      { type: "text", text: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô", size: "sm", color: "#888888", flex: 3 },
                      { type: "text", text: formatDate(borrow.return_date), size: "sm", color: accentColor, flex: 5, weight: "bold" }
                    ]
                  },
                  {
                    type: "box",
                    layout: "baseline",
                    contents: [
                      { type: "text", text: "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏∑‡∏°", size: "sm", color: "#888888", flex: 3 },
                      { type: "text", text: `${totalDays} ‡∏ß‡∏±‡∏ô`, size: "sm", color: "#111111", flex: 5, weight: "bold" }
                    ]
                  },
                  { type: "separator", margin: "md" },
                  {
                    type: "text",
                    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î",
                    size: "sm",
                    color: "#666666",
                    wrap: true
                  }
                ]
              },
              footer: {
                type: "box",
                layout: "vertical",
                spacing: "sm",
                contents: [
                  {
                    type: "button",
                    style: "primary",
                    color: accentColor,
                    action: {
                      type: "uri",
                      label: "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î",
                      uri: "https://e-borrow-system.vercel.app"
                    }
                  }
                ]
              }
            }
          };

          try {
            console.log(`Sending to ${borrow.line_id}: ${message.altText || '[Flex Message]'}`);
            await client.pushMessage(borrow.line_id, message);
            await new Promise(resolve => setTimeout(resolve, 200));
          } catch (sendError) {
            console.error(`Error sending message to ${borrow.line_id}:`, sendError, sendError.response?.data);
          }
        }
      }
    }
  } catch (error) {
    console.error('Error in notification job:', error);
  }
}, { timezone: 'Asia/Bangkok' });

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Location Tracking Cron Job
const startLocationTrackingCron = () => {
  console.log('Starting Location Tracking Cron Job...');
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
  cron.schedule('*/1 * * * *', async () => {
    try {
      console.log('Location Tracking Cron: Checking for active borrows...');
      
      // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà active ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      const [activeBorrows] = await db.execute(`
        SELECT 
          bt.borrow_id,
          bt.user_id,
          bt.status,
          bt.borrower_location,
          bt.last_location_update,
          u.username,
          u.email
        FROM borrow_transactions bt
        JOIN users u ON bt.user_id = u.user_id
        WHERE bt.status IN ('approved', 'carry')
        AND bt.borrower_location IS NOT NULL
        AND bt.last_location_update IS NOT NULL
      `);
      
      console.log(`Location Tracking Cron: Found ${activeBorrows.length} active borrows`);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      for (const borrow of activeBorrows) {
        const lastUpdate = new Date(borrow.last_location_update);
        const now = new Date();
        const timeDiff = now.getTime() - lastUpdate.getTime();
        const minutesDiff = Math.floor(timeDiff / (1000 * 60));
        
        // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (minutesDiff > 1) {
          console.log(`Location Tracking Cron: Borrow ${borrow.borrow_id} last update was ${minutesDiff} minutes ago`);
          
          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô carry ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÅ‡∏ó‡∏ô overdue)
          if (minutesDiff > 30) { // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
            await db.execute(`
              UPDATE borrow_transactions 
              SET status = 'carry', 
                  last_location_update = NOW()
              WHERE borrow_id = ?
            `, [borrow.borrow_id]);
            
            console.log(`Location Tracking Cron: Updated borrow ${borrow.borrow_id} status to carry`);
          }
        }
      }
      
    } catch (error) {
      console.error('Location Tracking Cron Error:', error);
    }
  });
  
  console.log('Location Tracking Cron Job started successfully');
};

// ‡πÄ‡∏û‡∏¥‡πà‡∏° Notification Cron Job function
const startNotificationCron = () => {
  console.log('Starting Notification Cron Job...');
  // Notification cron job is already scheduled above with cron.schedule('29 0 * * *', ...)
  console.log('Notification Cron Job started successfully');
};

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô cron jobs
startLocationTrackingCron();
startNotificationCron();

export { startNotificationCron, startLocationTrackingCron };
